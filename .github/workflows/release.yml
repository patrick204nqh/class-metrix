name: Release Gem

permissions:
  contents: write
  packages: write
  id-token: write

on:
  push:
    tags:
      - v*
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.2)"
        required: true
        type: string
      dry_run:
        description: "Dry run (skip actual publishing)"
        required: false
        type: boolean
        default: false

env:
  RUBY_VERSION: "3.3"

jobs:
  validate-release:
    runs-on: ubuntu-latest
    name: Validate Release
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
      should_release: ${{ steps.validate.outputs.should_release }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag or input
        id: extract_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            echo "Manual release triggered for version: $VERSION"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "Tag-triggered release for version: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Validate version format
        id: validate
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"

          # Check semantic versioning format
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Expected semantic versioning format: X.Y.Z[-prerelease][+build]"
            exit 1
          fi

          # Verify version consistency with gemspec
          GEMSPEC_VERSION=$(ruby -e "require './lib/class_metrix/version'; puts ClassMetrix::VERSION")
          echo "Gemspec version: $GEMSPEC_VERSION"
          echo "Release version: $VERSION"

          if [ "$GEMSPEC_VERSION" != "$VERSION" ]; then
            echo "âŒ Version mismatch!"
            echo "Gemspec version: $GEMSPEC_VERSION"
            echo "Release version: $VERSION"
            echo "Please update lib/class_metrix/version.rb to match the release version"
            exit 1
          fi

          # Check if this version already exists on RubyGems
          if gem list class-metrix --remote --exact | grep -q "($VERSION)"; then
            echo "âŒ Version $VERSION already exists on RubyGems"
            exit 1
          fi

          echo "âœ… Version validation passed"
          echo "should_release=true" >> $GITHUB_OUTPUT

  test:
    needs: validate-release
    runs-on: ubuntu-latest
    name: Test Ruby ${{ matrix.ruby }}
    if: needs.validate-release.outputs.should_release == 'true'
    strategy:
      fail-fast: true
      matrix:
        ruby: ["3.2", "3.3"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby ${{ matrix.ruby }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler-cache: true

      - name: Run comprehensive tests
        run: |
          echo "ğŸ§ª Running tests for Ruby ${{ matrix.ruby }}"
          bundle exec rake spec

      - name: Run security scan
        if: matrix.ruby == env.RUBY_VERSION
        run: |
          echo "ğŸ”’ Running security scan"
          bundle exec brakeman --force --format json --output tmp/brakeman-release.json --exit-on-warn || true

      - name: Run quality checks
        if: matrix.ruby == env.RUBY_VERSION
        run: |
          echo "ğŸ“Š Running quality checks"
          bundle exec rubocop

  build-and-publish:
    needs: [validate-release, test]
    runs-on: ubuntu-latest
    name: Build and Publish Gem
    if: needs.validate-release.outputs.should_release == 'true'
    environment:
      name: production
      url: https://rubygems.org/gems/class-metrix

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Build gem
        id: build
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"
          echo "ğŸ”¨ Building gem version $VERSION"
          gem build class-metrix.gemspec

          # Verify gem was built
          GEM_FILE="class-metrix-${VERSION}.gem"
          if [ ! -f "$GEM_FILE" ]; then
            echo "âŒ Gem file not found: $GEM_FILE"
            exit 1
          fi

          # Test gem installation locally
          echo "ğŸ§ª Testing gem installation"
          gem install "$GEM_FILE" --local

          # Verify gem functionality
          ruby -e "require 'class_metrix'; puts 'âœ… Gem loads successfully'"

          echo "gem_file=$GEM_FILE" >> $GITHUB_OUTPUT

      - name: Dry run check
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "ğŸƒâ€â™‚ï¸ DRY RUN MODE - Skipping actual publishing"
          echo "Would publish: ${{ steps.build.outputs.gem_file }}"
          exit 0

      - name: Setup RubyGems credentials
        if: github.event.inputs.dry_run != 'true'
        run: |
          mkdir -p ~/.gem
          cat > ~/.gem/credentials << EOF
          ---
          :rubygems_api_key: ${{ secrets.RUBYGEMS_API_KEY }}
          EOF
          chmod 0600 ~/.gem/credentials

      - name: Publish to RubyGems
        if: github.event.inputs.dry_run != 'true'
        id: publish
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"
          GEM_FILE="${{ steps.build.outputs.gem_file }}"

          echo "ğŸš€ Publishing $GEM_FILE to RubyGems"
          gem push "$GEM_FILE"

          echo "âœ… Successfully published class-metrix $VERSION to RubyGems"
          echo "published=true" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: github.event.inputs.dry_run != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.validate-release.outputs.version }}
          name: Release ${{ needs.validate-release.outputs.version }}
          body: |
            ## ğŸš€ ClassMetrix v${{ needs.validate-release.outputs.version }}

            ### Installation

            ```bash
            gem install class-metrix -v ${{ needs.validate-release.outputs.version }}
            ```

            Or add to your Gemfile:

            ```ruby
            gem 'class-metrix', '~> ${{ needs.validate-release.outputs.version }}'
            ```

            ### Changes

            See [CHANGELOG.md](CHANGELOG.md) for detailed changes in this release.

            ### Links

            - ğŸ“¦ [RubyGems](https://rubygems.org/gems/class-metrix/versions/${{ needs.validate-release.outputs.version }})
            - ğŸ“š [Documentation](https://github.com/${{ github.repository }}/blob/v${{ needs.validate-release.outputs.version }}/README.md)
            - ğŸ› [Issues](https://github.com/${{ github.repository }}/issues)
          draft: false
          prerelease: false
          files: ${{ steps.build.outputs.gem_file }}

      - name: Upload gem artifact
        uses: actions/upload-artifact@v4
        with:
          name: class-metrix-gem-${{ needs.validate-release.outputs.version }}
          path: ${{ steps.build.outputs.gem_file }}
          retention-days: 90

  post-release:
    needs: [validate-release, build-and-publish]
    runs-on: ubuntu-latest
    name: Post-Release Tasks
    if: needs.validate-release.outputs.should_release == 'true' && github.event.inputs.dry_run != 'true'
    steps:
      - name: Verify publication
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"
          echo "â³ Waiting for gem to be available on RubyGems..."

          # Wait up to 5 minutes for the gem to be available
          for i in {1..30}; do
            if gem list class-metrix --remote --exact | grep -q "($VERSION)"; then
              echo "âœ… Gem $VERSION is now available on RubyGems"
              break
            fi
            echo "Waiting... (attempt $i/30)"
            sleep 10
          done

      - name: Notify success
        run: |
          echo "ğŸ‰ Release v${{ needs.validate-release.outputs.version }} completed successfully!"
          echo "ğŸ“¦ Gem published to RubyGems"
          echo "ğŸ·ï¸ GitHub release created"
          echo "ğŸ”— https://rubygems.org/gems/class-metrix/versions/${{ needs.validate-release.outputs.version }}"
