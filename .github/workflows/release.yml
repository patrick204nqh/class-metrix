name: Release Gem

permissions:
  contents: write
  packages: write
  id-token: write

on:
  push:
    tags:
      - v*
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.2)"
        required: true
        type: string
      dry_run:
        description: "Dry run (skip actual publishing)"
        required: false
        type: boolean
        default: false

env:
  RUBY_VERSION: "3.3"

jobs:
  validate-release:
    runs-on: ubuntu-latest
    name: Validate Release
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
      should_release: ${{ steps.validate.outputs.should_release }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag or input
        id: extract_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            echo "Manual release triggered for version: $VERSION"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "Tag-triggered release for version: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Validate version format
        id: validate
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"

          # Check semantic versioning format
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$ ]]; then
            echo "‚ùå Invalid version format: $VERSION"
            echo "Expected semantic versioning format: X.Y.Z[-prerelease][+build]"
            exit 1
          fi

          # Verify version consistency with gemspec
          GEMSPEC_VERSION=$(ruby -e "require './lib/class_metrix/version'; puts ClassMetrix::VERSION")
          echo "Gemspec version: $GEMSPEC_VERSION"
          echo "Release version: $VERSION"

          if [ "$GEMSPEC_VERSION" != "$VERSION" ]; then
            echo "‚ùå Version mismatch!"
            echo "Gemspec version: $GEMSPEC_VERSION"
            echo "Release version: $VERSION"
            echo "Please update lib/class_metrix/version.rb to match the release version"
            exit 1
          fi

          # Check if this version already exists on RubyGems
          if gem list class-metrix --remote --exact | grep -q "($VERSION)"; then
            echo "‚ùå Version $VERSION already exists on RubyGems"
            exit 1
          fi

          echo "‚úÖ Version validation passed"
          echo "should_release=true" >> $GITHUB_OUTPUT

  test:
    needs: validate-release
    runs-on: ubuntu-latest
    name: Test Ruby ${{ matrix.ruby }}
    if: needs.validate-release.outputs.should_release == 'true'
    strategy:
      fail-fast: true
      matrix:
        ruby: ["3.2", "3.3"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby ${{ matrix.ruby }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler-cache: true

      - name: Run comprehensive tests
        run: |
          echo "üß™ Running tests for Ruby ${{ matrix.ruby }}"
          bundle exec rake spec

      - name: Run security scan
        if: matrix.ruby == env.RUBY_VERSION
        run: |
          echo "üîí Running security scan"
          bundle exec brakeman --force --format json --output tmp/brakeman-release.json --exit-on-warn || true

      - name: Run quality checks
        if: matrix.ruby == env.RUBY_VERSION
        run: |
          echo "üìä Running quality checks"
          bundle exec rubocop

  build-and-publish:
    needs: [validate-release, test]
    runs-on: ubuntu-latest
    name: Build and Publish Gem
    if: needs.validate-release.outputs.should_release == 'true'
    environment:
      name: production
      url: https://rubygems.org/gems/class-metrix

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Build gem
        id: build
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"
          echo "üî® Building gem version $VERSION"
          gem build class-metrix.gemspec

          # Verify gem was built
          GEM_FILE="class-metrix-${VERSION}.gem"
          if [ ! -f "$GEM_FILE" ]; then
            echo "‚ùå Gem file not found: $GEM_FILE"
            exit 1
          fi

          # Test gem installation locally
          echo "üß™ Testing gem installation"
          gem install "$GEM_FILE" --local

          # Verify gem functionality
          ruby -e "require 'class_metrix'; puts '‚úÖ Gem loads successfully'"

          echo "gem_file=$GEM_FILE" >> $GITHUB_OUTPUT

      - name: Dry run check
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "üèÉ‚Äç‚ôÇÔ∏è DRY RUN MODE - Skipping actual publishing"
          echo "Would publish: ${{ steps.build.outputs.gem_file }}"
          exit 0

      - name: Setup RubyGems credentials
        if: github.event.inputs.dry_run != 'true'
        run: |
          mkdir -p ~/.gem
          cat > ~/.gem/credentials << EOF
          ---
          :rubygems_api_key: ${{ secrets.RUBYGEMS_API_KEY }}
          EOF
          chmod 0600 ~/.gem/credentials

      - name: Publish to RubyGems
        if: github.event.inputs.dry_run != 'true'
        id: publish
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"
          GEM_FILE="${{ steps.build.outputs.gem_file }}"

          echo "üöÄ Publishing $GEM_FILE to RubyGems"
          gem push "$GEM_FILE"

          echo "‚úÖ Successfully published class-metrix $VERSION to RubyGems"
          echo "published=true" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: github.event.inputs.dry_run != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.validate-release.outputs.version }}
          name: Release ${{ needs.validate-release.outputs.version }}
          body: |
            ## üöÄ ClassMetrix v${{ needs.validate-release.outputs.version }}

            ### Installation

            ```bash
            gem install class-metrix -v ${{ needs.validate-release.outputs.version }}
            ```

            Or add to your Gemfile:

            ```ruby
            gem 'class-metrix', '~> ${{ needs.validate-release.outputs.version }}'
            ```

            ### Changes

            See [CHANGELOG.md](CHANGELOG.md) for detailed changes in this release.

            ### Links

            - üì¶ [RubyGems](https://rubygems.org/gems/class-metrix/versions/${{ needs.validate-release.outputs.version }})
            - üìö [Documentation](https://github.com/${{ github.repository }}/blob/v${{ needs.validate-release.outputs.version }}/README.md)
            - üêõ [Issues](https://github.com/${{ github.repository }}/issues)
          draft: false
          prerelease: false
          files: ${{ steps.build.outputs.gem_file }}

      - name: Upload gem artifact
        uses: actions/upload-artifact@v4
        with:
          name: class-metrix-gem-${{ needs.validate-release.outputs.version }}
          path: ${{ steps.build.outputs.gem_file }}
          retention-days: 90

  post-release:
    needs: [validate-release, build-and-publish]
    runs-on: ubuntu-latest
    name: Post-Release Tasks
    if: needs.validate-release.outputs.should_release == 'true' && github.event.inputs.dry_run != 'true'
    steps:
      - name: Verify publication
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"
          echo "‚è≥ Waiting for gem to be available on RubyGems..."

          # Wait up to 5 minutes for the gem to be available
          for i in {1..30}; do
            if gem list class-metrix --remote --exact | grep -q "($VERSION)"; then
              echo "‚úÖ Gem $VERSION is now available on RubyGems"
              break
            fi
            echo "Waiting... (attempt $i/30)"
            sleep 10
          done

      - name: Notify success
        run: |
          echo "üéâ Release v${{ needs.validate-release.outputs.version }} completed successfully!"
          echo "üì¶ Gem published to RubyGems"
          echo "üè∑Ô∏è GitHub release created"
          echo "üîó https://rubygems.org/gems/class-metrix/versions/${{ needs.validate-release.outputs.version }}"

      - name: Notify Slack - Release Complete
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          custom_payload: |
            {
              "channel": "#cicd-notifications",
              "username": "GitHub Actions",
              "icon_emoji": ":rocket:",
              "attachments": [{
                "color": "good",
                "fallback": "ClassMetrix v${{ needs.validate-release.outputs.version }} released successfully!",
                "title": "üöÄ ClassMetrix Release Complete",
                "title_link": "https://github.com/${{ github.repository }}/releases/tag/v${{ needs.validate-release.outputs.version }}",
                "fields": [
                  {
                    "title": "Version",
                    "value": "v${{ needs.validate-release.outputs.version }}",
                    "short": true
                  },
                  {
                    "title": "Trigger",
                    "value": "${{ github.event_name == 'workflow_dispatch' && 'Manual' || 'Tag Push' }}",
                    "short": true
                  },
                  {
                    "title": "Installation",
                    "value": "`gem install class-metrix -v ${{ needs.validate-release.outputs.version }}`",
                    "short": false
                  },
                  {
                    "title": "Links",
                    "value": "üì¶ <https://rubygems.org/gems/class-metrix/versions/${{ needs.validate-release.outputs.version }}|RubyGems> ‚Ä¢ üìö <https://github.com/${{ github.repository }}/releases/tag/v${{ needs.validate-release.outputs.version }}|GitHub Release>",
                    "short": false
                  }
                ],
                "footer": "Released by ${{ github.actor }} ‚Ä¢ GitHub Actions",
                "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                "ts": ${{ github.event.head_commit.timestamp }}
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  notify-failure:
    needs: [validate-release, build-and-publish, post-release]
    runs-on: ubuntu-latest
    name: Notify on Failure
    if: always() && (failure() || cancelled()) && needs.validate-release.outputs.should_release == 'true'
    steps:
      - name: Determine failed job
        id: failed_job
        run: |
          if [[ "${{ needs.validate-release.result }}" == "failure" ]]; then
            echo "failed_step=Validation" >> $GITHUB_OUTPUT
            echo "failed_reason=Version validation or format check failed" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.build-and-publish.result }}" == "failure" ]]; then
            echo "failed_step=Build & Publish" >> $GITHUB_OUTPUT
            echo "failed_reason=Gem build or RubyGems publishing failed" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.post-release.result }}" == "failure" ]]; then
            echo "failed_step=Post-Release" >> $GITHUB_OUTPUT
            echo "failed_reason=Release verification or notification failed" >> $GITHUB_OUTPUT
          else
            echo "failed_step=Unknown" >> $GITHUB_OUTPUT
            echo "failed_reason=Workflow was cancelled or failed unexpectedly" >> $GITHUB_OUTPUT
          fi

      - name: Notify Slack - Release Failure
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          custom_payload: |
            {
              "channel": "#cicd-notifications",
              "username": "GitHub Actions",
              "icon_emoji": ":x:",
              "attachments": [{
                "color": "danger",
                "fallback": "ClassMetrix release failed!",
                "title": "‚ùå ClassMetrix Release Failed",
                "title_link": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                "fields": [
                  {
                    "title": "Failed Step",
                    "value": "${{ steps.failed_job.outputs.failed_step }}",
                    "short": true
                  },
                  {
                    "title": "Version",
                    "value": "v${{ needs.validate-release.outputs.version || github.event.inputs.version || 'Unknown' }}",
                    "short": true
                  },
                  {
                    "title": "Reason",
                    "value": "${{ steps.failed_job.outputs.failed_reason }}",
                    "short": false
                  },
                  {
                    "title": "Repository",
                    "value": "<https://github.com/${{ github.repository }}|${{ github.repository }}>",
                    "short": true
                  },
                  {
                    "title": "Workflow Run",
                    "value": "<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>",
                    "short": true
                  },
                  {
                    "title": "Triggered By",
                    "value": "${{ github.actor }}",
                    "short": true
                  }
                ],
                "footer": "GitHub Actions",
                "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                "ts": ${{ github.event.head_commit.timestamp }}
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
