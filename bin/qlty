#!/usr/bin/env bash

# Qlty integration script for ClassMetrix
# This script provides convenient commands for running Qlty checks

set -e

QLTY_BIN="$HOME/.qlty/bin/qlty"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${BLUE}[Qlty]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[Qlty]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[Qlty]${NC} $1"
}

print_error() {
    echo -e "${RED}[Qlty]${NC} $1"
}

# Check if Qlty is installed
check_qlty_installation() {
    if [[ ! -f "$QLTY_BIN" ]]; then
        print_error "Qlty is not installed at $QLTY_BIN"
        print_status "To install Qlty, run: curl -fsSL https://qlty.sh/install | sh"
        exit 1
    fi
}

# Show usage information
show_usage() {
    echo "Usage: $0 [command]"
    echo ""
    echo "Commands:"
    echo "  check              Run all quality checks"
    echo "  check-critical     Run only high-priority checks"
    echo "  check-changed      Check only changed files"
    echo "  fix                Auto-fix issues where possible"
    echo "  summary            Show a summary of issues"
    echo "  init               Initialize Qlty in this project"
    echo "  version            Show Qlty version"
    echo "  help               Show this help message"
}

# Run full check
run_check() {
    print_status "Running full Qlty check..."
    "$QLTY_BIN" check --all
}

# Run critical checks only
run_critical_check() {
    print_status "Running critical (high-level) checks only..."
    "$QLTY_BIN" check --all --level high
}

# Check only changed files
run_changed_check() {
    print_status "Running Qlty check on changed files..."
    "$QLTY_BIN" check
}

# Auto-fix issues
run_fix() {
    print_status "Running Qlty auto-fix..."
    "$QLTY_BIN" check --fix
}

# Show summary
run_summary() {
    print_status "Generating Qlty summary..."
    "$QLTY_BIN" check --summary
}

# Initialize Qlty
run_init() {
    print_status "Initializing Qlty..."
    "$QLTY_BIN" init
}

# Show version
show_version() {
    "$QLTY_BIN" --version
}

# Main script logic
main() {
    check_qlty_installation

    case "${1:-}" in
    "check")
        run_check
        ;;
    "check-critical")
        run_critical_check
        ;;
    "check-changed")
        run_changed_check
        ;;
    "fix")
        run_fix
        ;;
    "summary")
        run_summary
        ;;
    "init")
        run_init
        ;;
    "version")
        show_version
        ;;
    "help" | "--help" | "-h")
        show_usage
        ;;
    "")
        print_status "No command specified. Running summary check..."
        run_summary
        ;;
    *)
        print_error "Unknown command: $1"
        show_usage
        exit 1
        ;;
    esac
}

main "$@"
